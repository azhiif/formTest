<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Add Staff</title>
  <style>body{font-family:Arial;padding:20px}label{display:block;margin:8px 0}input[type="text"],input[type="email"],input[type="number"],input[type="date"],textarea{width:100%;padding:6px}</style>
</head>
<body>
  <h2>Add Staff</h2>
  <form id="form">
    <label>Name<input name="name" required></label>
    <label>Phone 1<input name="phone1" required></label>
    <label>Phone 2<input name="phone2"></label>
    <label>Address<textarea name="address"></textarea></label>
    <label>Aadhaar Number<input name="adhaar"></label>
    <label>Salary<input name="salary" type="number" step="0.01"></label>
    <label>Photo<input name="photo" type="file" accept="image/*"></label>
    <label>Parents Name<input name="parents_name"></label>
    <label>Post<input name="post"></label>
    <label>District<input name="district"></label>
    <label>Email<input name="email" type="email"></label>
    <label>Date of Birth<input name="dob" type="date"></label>
    <label>Spouse Name (if any)<input name="spouse_name"></label>
    <label>Work Location<input name="work_location"></label>
    <label>Department<input name="department"></label>
    <label>Joining Date<input name="joining_date" type="date"></label>
    <div style="margin-top:12px">
      <button type="submit">Save Staff</button>
      <a href="index.html" style="margin-left:12px">Back</a>
    </div>
  </form>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // << REPLACE >>
    const SUPABASE_URL = "https://bclxscvpjkewftbeeqjd.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJjbHhzY3Zwamtld2Z0YmVlcWpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4ODAyMDUsImV4cCI6MjA3OTQ1NjIwNX0.0kLf4dvMCtH467a-XqZlf6WP7KA9xBIeLGJ8TUBXodI";


    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const BUCKET = "staff-photos"; // create this bucket in Supabase Storage

    async function uploadPhoto(file) {
      if (!file) return null;
      const ext = file.name.split('.').pop();
      const filename = `staff_${Date.now()}.${ext}`;
      const { data, error } = await supabase.storage.from(BUCKET).upload(filename, file, { upsert: false });
      if (error) {
        console.error("Upload error:", error);
        throw error;
      }
      // public URL (if bucket is public)
      const { publicUrl } = supabase.storage.from(BUCKET).getPublicUrl(filename);
      return publicUrl;
    }

    document.getElementById('form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const f = e.target;
      const btn = f.querySelector('button[type="submit"]');
      btn.disabled = true; btn.innerText = 'Saving...';

      try {
        const fileInput = f.photo.files[0];
        let photo_url = null;
        if (fileInput) {
          try {
            photo_url = await uploadPhoto(fileInput);
          } catch (upErr) {
            alert('Photo upload failed: ' + (upErr.message || upErr));
            btn.disabled = false; btn.innerText = 'Save Staff';
            return;
          }
        }

        const payload = {
          name: f.name.value.trim(),
          phone1: f.phone1.value.trim(),
          phone2: f.phone2.value.trim(),
          address: f.address.value.trim(),
          adhaar: f.adhaar.value.trim(),
          salary: f.salary.value ? parseFloat(f.salary.value) : null,
          photo_url: photo_url,
          parents_name: f.parents_name.value.trim(),
          post: f.post.value.trim(),
          district: f.district.value.trim(),
          email: f.email.value.trim(),
          dob: f.dob.value || null,
          spouse_name: f.spouse_name.value.trim(),
          work_location: f.work_location.value.trim(),
          department: f.department.value.trim(),
          joining_date: f.joining_date.value || null
        };

        const { data, error } = await supabase.from('staff').insert([payload]).select();
        console.log('Insert staff result:', { data, error });
        if (error) {
          alert('Save error: ' + error.message);
        } else {
          alert('Staff saved âœ“');
          f.reset();
        }
      } finally {
        btn.disabled = false; btn.innerText = 'Save Staff';
      }
    });
  </script>
</body>
</html>
